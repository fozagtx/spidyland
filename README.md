

# Eternal USDC

Secure digital inheritance platform with automated USDC transfers using blockchain technology.

## Table of contents

- [Clone and run locally](#clone-and-run-locally)
- [Using Supabase Cloud](#using-supabase-cloud)
- [Using Replit](#using-replit)
- [Project Structure](#project-structure)

## Clone and run locally

1. Clone the repository and install dependencies:

   ```bash
   git clone https://github.com/[username]/eternal-usdc.git
   cd eternal-usdc
   npm install
   ```

2. Rename `.env.example` to `.env.local` and update the following:

   ```
   # Deployment URL (e.g., http://localhost:3000)
   VERCEL_URL=http://localhost:3000
   NEXT_PUBLIC_VERCEL_URL=http://localhost:3000

   # Supabase configuration (https://app.supabase.com/project/_/settings/api)
   NEXT_PUBLIC_SUPABASE_URL=
   NEXT_PUBLIC_SUPABASE_ANON_KEY=

   # USDC Smart Contract configuration
   NEXT_PUBLIC_USDC_CONTRACT_ADDRESS=

   # Agent Wallet configuration
   NEXT_PUBLIC_AGENT_WALLET_ID=<leave blank>
   NEXT_PUBLIC_AGENT_WALLET_ADDRESS=<leave blank>

   # Circle API configuration (https://console.circle.com/apikeys)
   CIRCLE_API_KEY=
   CIRCLE_ENTITY_SECRET=
   CIRCLE_BLOCKCHAIN=<leave blank>

   # Mistral AI API configuration (https://console.mistral.ai/api-keys/)
   MISTRAL_API_KEY=
   ```
   - `VERCEL_URL` and `NEXT_PUBLIC_VERCEL_URL` is the base URL of the project (i.e. `http://localhost:3000/` when developing locally).

   - `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` can be found in [your Supabase project's API settings](https://app.supabase.com/project/_/settings/api).

   - `CIRCLE_API_KEY` can be found in the [API Keys](https://console.circle.com/api-keys) section of Circle's console, while `CIRCLE_ENTITY_SECRET` must be shared, or rotated [here](https://console.circle.com/wallets/dev/configurator/entity-secret) in case it's lost.


   - `MISTRAL_API_KEY` can be found in the [API Keys](https://console.mistral.ai/api-keys/) section of your Mistral AI account.

   - `NEXT_PUBLIC_USDC_CONTRACT_ADDRESS` is documented [here](https://developers.circle.com/stablecoins/usdc-on-test-networks) alongside other blockchain test networks, like Polygon PoS Amoy (the one used in the project). This is used for the USDC approval function, which gives permission for a dapp to access and move a specific type of token from your wallet. The address for Polygon PoS Amoy is `0x41e94eb019c0762f9bfcf9fb1e58725bfb0e7582`.

   Leave the follwing vars blank. These variables will be automatically generated by the generate-wallet.mjs script ins step 3:

   - `CIRCLE_BLOCKCHAIN` can be left blank. This is the blockchain network the escrow contracts will be deployed to.

   - `NEXT_PUBLIC_AGENT_WALLET_ID` and `NEXT_PUBLIC_AGENT_WALLET_ADDRESS` can be left blank. This is the wallet used by the escrow agent to interact with the escrow contracts.

3. Run the generate-wallet.mjs script to craete the agent wallet and updated the environment variables:

   ```bash
   npm run generate-wallet
   ```

4. Then start a local instance of the Supabase server:

   ```bash
   npx supabase start
   ```

5. Initialize the database schema:

   ```bash
   npx supabase migration up
   ```

6. You can now run the Next.js local development server:

   ```bash
   npm run dev
   ```

   The starter kit should now be running on [localhost:3000](http://localhost:3000/).

7. With the project up and running, open an ngrok tunnel on the same port as of the local development server:

   ```bash
   ngrok http 3000
   ```

8. Configure the Circle webhook:

   1. Go to [Circle Webhooks Dashboard](https://console.circle.com/webhooks)
   2. Click "Add Webhook"
   3. Configure the following settings:
      - URL: Your ngrok URL + `/api/webhooks/circle` (e.g., `https://9940-170-239-106-57.ngrok-free.app/api/webhooks/circle`)
      - Limit to specific events: Disabled
   4. Save the webhook configuration

   Note: The webhook is essential for processing transaction status updates. Ensure it's properly configured before testing transactions.

9. This template comes with the default shadcn/ui style initialized. If you instead want other ui.shadcn styles, delete `components.json` and [re-install shadcn/ui](https://ui.shadcn.com/docs/installation/next)

> Check out [the docs for Local Development](https://supabase.com/docs/guides/getting-started/local-development) to also run Supabase locally.

## Using Supabase Cloud

If you prefer to use Supabase Cloud instead of running Supabase locally:

1. Clone the repository and install dependencies:

   ```bash
   git clone https://github.com/circlefin/eternal-usdc.git
   cd eternal-usdc
   npm install
   ```

2. Rename `.env.example` to `.env.local` and update the following:

   ```
   # Deployment URL (e.g., http://localhost:3000)
   VERCEL_URL=http://localhost:3000
   NEXT_PUBLIC_VERCEL_URL=http://localhost:3000

   # Supabase configuration (https://app.supabase.com/project/_/settings/api)
   NEXT_PUBLIC_SUPABASE_URL=
   NEXT_PUBLIC_SUPABASE_ANON_KEY=

   # USDC Smart Contract configuration
   NEXT_PUBLIC_USDC_CONTRACT_ADDRESS=

   # Agent Wallet configuration
   NEXT_PUBLIC_AGENT_WALLET_ID=<leave blank>
   NEXT_PUBLIC_AGENT_WALLET_ADDRESS=<leave blank>

   # Circle API configuration (https://console.circle.com/apikeys)
   CIRCLE_API_KEY=
   CIRCLE_ENTITY_SECRET=
   CIRCLE_BLOCKCHAIN=<leave blank>

   # Mistral AI API configuration (https://console.mistral.ai/api-keys/)
   MISTRAL_API_KEY=
   ```

   - `VERCEL_URL` and `NEXT_PUBLIC_VERCEL_URL` is the base URL of the project (i.e. `http://localhost:3000/` when developing locally).

   - `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` can be found in [your Supabase project's API settings](https://app.supabase.com/project/_/settings/api).

   - `CIRCLE_API_KEY` can be found in the [API Keys](https://console.circle.com/api-keys) section of Circle's console, while `CIRCLE_ENTITY_SECRET` must be shared, or rotated [here](https://console.circle.com/wallets/dev/configurator/entity-secret) in case it's lost.

   - `MISTRAL_API_KEY` can be found in the [API Keys](https://console.mistral.ai/api-keys/) section of your Mistral AI account.

   - `NEXT_PUBLIC_USDC_CONTRACT_ADDRESS` is documented [here](https://developers.circle.com/stablecoins/usdc-on-test-networks) alongside other blockchain test networks, like Polygon PoS Amoy (the one used in the project). This is used for the USDC approval function, which gives permission for a dapp to access and move a specific type of token from your wallet. The address for Polygon PoS Amoy is `0x41e94eb019c0762f9bfcf9fb1e58725bfb0e7582`.

   Leave the follwing vars blank. These variables will be automatically generated by the generate-wallet.mjs script in step 3:

   - `CIRCLE_BLOCKCHAIN` can be left blank. This is the blockchain network the escrow contracts will be deployed to.

   - `NEXT_PUBLIC_AGENT_WALLET_ID` and `NEXT_PUBLIC_AGENT_WALLET_ADDRESS` can be left blank. This is the wallet used by the escrow agent to interact with the escrow contracts.

3. Run the generate-wallet.mjs script to craete the agent wallet and updated the environment variables:

   ```bash
   npm run generate-wallet
   ```

4. Create a new project on [Supabase](https://app.supabase.com)

5. Set up authentication:
   - Go to Authentication > Providers
   - Enable Email provider
   - Disable "Confirm Email" to allow immediate sign-ins

6. Link your local project to your Supabase cloud project and push the database schema:
   ```bash
   # Install Supabase CLI if you haven't already
   npm install supabase --save-dev

   # Link to your remote project - you'll need your project ID and database password
   npx supabase link --project-ref <project-id>

   # Push the database schema
   npx supabase db push
   ```
   > Note: You can find your project ID in your Supabase project settings under Project Settings > General

7. You can now run the Next.js development server:

   ```bash
   npm run dev
   ```

8. With the project up and running, open an ngrok tunnel on the same port as of the local development server:

   ```bash
   ngrok http 3000
   ```

9. Configure the Circle webhook:

   1. Go to [Circle Webhooks Dashboard](https://console.circle.com/webhooks)
   2. Click "Add Webhook"
   3. Configure the following settings:
      - URL: Your ngrok URL + `/api/webhooks/circle` (e.g., `https://9940-170-239-106-57.ngrok-free.app/api/webhooks/circle`)
      - Limit to specific events: Disabled
   4. Save the webhook configuration

   Note: The webhook is essential for processing transaction status updates. Ensure it's properly configured before testing transactions.

## Complete Deployment Guide on Replit

This comprehensive guide will walk you through deploying Eternal USDC on Replit from start to finish.

### Prerequisites

Before starting, you'll need:
- A Replit account (free tier works)
- A Supabase account (free tier works)
- A Circle Developer account for API keys
- A Mistral AI account for API keys

### Step 1: Set Up Your Replit Project

1. **Fork this repository on Replit:**
   - Go to the GitHub repository
   - Click "Fork to Replit" or manually import the repository
   - Choose a name for your Repl (e.g., "eternal-usdc-app")

2. **Install dependencies:**
   ```bash
   bun install
   ```

### Step 2: Configure Environment Variables

Click on the "Secrets" tool in the Tools panel and add these environment variables:

#### Required Secrets:

```bash
# Replit URLs (update after first run)
VERCEL_URL=https://your-repl-name.your-username.replit.dev
NEXT_PUBLIC_VERCEL_URL=https://your-repl-name.your-username.replit.dev

# Supabase (get from step 3)
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# USDC Contract
NEXT_PUBLIC_USDC_CONTRACT_ADDRESS=0x41e94eb019c0762f9bfcf9fb1e58725bfb0e7582

# Circle API (get from Circle Developer Console)
CIRCLE_API_KEY=your_circle_api_key
CIRCLE_ENTITY_SECRET=your_circle_entity_secret
CIRCLE_BLOCKCHAIN=MATIC-AMOY

# Mistral AI (get from Mistral Console)
MISTRAL_API_KEY=your_mistral_api_key

# Agent Wallet (will be generated in step 5)
NEXT_PUBLIC_AGENT_WALLET_ID=
NEXT_PUBLIC_AGENT_WALLET_ADDRESS=
```

### Step 3: Set Up Supabase

1. **Create a Supabase project:**
   - Go to [supabase.com](https://supabase.com)
   - Click "Start your project"
   - Create a new project (choose a region close to you)
   - Wait for the project to be ready

2. **Get your Supabase credentials:**
   - Go to Settings > API in your Supabase dashboard
   - Copy the Project URL and paste it as `NEXT_PUBLIC_SUPABASE_URL`
   - Copy the anon public key and paste it as `NEXT_PUBLIC_SUPABASE_ANON_KEY`

3. **Configure authentication:**
   - Go to Authentication > Providers
   - Enable Email provider
   - Disable "Confirm Email" for easier testing

### Step 4: Set Up Circle Developer Account

1. **Create Circle account:**
   - Go to [Circle Developer Console](https://console.circle.com)
   - Sign up for a developer account
   - Complete verification if required

2. **Get API credentials:**
   - Go to API Keys section
   - Create a new API key and copy it as `CIRCLE_API_KEY`
   - Go to Wallets > Configurator > Entity Secret
   - Copy the entity secret as `CIRCLE_ENTITY_SECRET`

### Step 5: Set Up Mistral AI

1. **Create Mistral AI account:**
   - Go to [Mistral AI Console](https://console.mistral.ai)
   - Sign up for an account
   - Navigate to API Keys section
   - Create a new API key and copy it as `MISTRAL_API_KEY`

### Step 6: Generate Agent Wallet

1. **Run the wallet generation script:**
   ```bash
   bun run generate-wallet
   ```

2. **Update secrets with generated values:**
   - The script will output wallet ID and address
   - Add these to your Replit Secrets:
     - `NEXT_PUBLIC_AGENT_WALLET_ID`
     - `NEXT_PUBLIC_AGENT_WALLET_ADDRESS`

### Step 7: Set Up Database Schema

1. **Install Supabase CLI:**
   ```bash
   bun add supabase --dev
   ```

2. **Link to your Supabase project:**
   ```bash
   bunx supabase link --project-ref your-project-id
   ```
   > Find your project ID in Supabase Dashboard > Settings > General

3. **Push the database schema:**
   ```bash
   bunx supabase db push
   ```

### Step 8: Test Development Server

1. **Start the development server:**
   ```bash
   bun run dev
   ```

2. **Test the application:**
   - Your app should be accessible at the Replit preview URL
   - Try signing up for an account
   - Test basic functionality

### Step 9: Configure Webhooks

1. **Get your Replit URL:**
   - After running your app, copy the URL from the preview pane
   - It should look like: `https://your-repl-name.your-username.replit.dev`

2. **Set up Circle webhook:**
   - Go to [Circle Webhooks Dashboard](https://console.circle.com/webhooks)
   - Click "Add Webhook"
   - URL: `https://your-repl-name.your-username.replit.dev/api/webhooks/circle`
   - Limit to specific events: Disabled
   - Save the webhook

3. **Update URL secrets:**
   - Update both `VERCEL_URL` and `NEXT_PUBLIC_VERCEL_URL` with your actual Replit URL

### Step 10: Deploy to Production

1. **Build the application:**
   ```bash
   bun run build
   ```

2. **Deploy using Replit Deployments:**
   - Click the "Deploy" button in the Replit header
   - Choose "Autoscale" deployment
   - Configure deployment settings:
     - **Build command:** `bun run build`
     - **Run command:** `bun run start`
     - **Environment variables:** All your secrets will be automatically included
   - Click "Deploy your project"

3. **Update webhook URL for production:**
   - Once deployed, you'll get a production URL (e.g., `https://your-app-name.replit.app`)
   - Update the Circle webhook URL to point to the production domain
   - Update the `VERCEL_URL` and `NEXT_PUBLIC_VERCEL_URL` secrets if needed

### Step 11: Final Testing

1. **Test all functionality:**
   - User registration/login
   - Wallet creation and balance checking
   - USDC operations
   - Inheritance contract creation
   - Agent wallet operations

2. **Monitor logs:**
   - Check the deployment logs for any errors
   - Monitor webhook activity in Circle console
   - Test webhook delivery with test transactions

### Troubleshooting

**Common issues and solutions:**

1. **Environment variables not loading:**
   - Ensure all secrets are properly set in Replit Secrets
   - Restart the Repl after adding new secrets

2. **Database connection issues:**
   - Verify Supabase URL and keys are correct
   - Check if database schema is properly pushed

3. **Circle API errors:**
   - Verify API keys are active and not expired
   - Check Circle console for API usage limits

4. **Webhook not receiving events:**
   - Verify webhook URL is accessible from internet
   - Check webhook configuration in Circle console
   - Test with manual webhook calls

### Production Considerations

- **Security:** Never commit secrets to code; always use Replit Secrets
- **Monitoring:** Set up logging and error tracking
- **Backup:** Regularly backup your Supabase database
- **Updates:** Keep dependencies updated for security patches

Your Eternal USDC application should now be fully deployed and operational on Replit!

## Project Structure

```
.
├── app/                    # Next.js 13+ app directory (main application code)
│   ├── actions/           # Server actions for form handling and data mutations
│   ├── api/               # API routes and endpoints
│   │   ├── contracts/     # Contract-related endpoints (analyze, escrow, validate)
│   │   ├── usdc/         # USDC token operations (buy, sell)
│   │   ├── wallet/       # Wallet operations (balance, transactions)
│   │   ├── wallet-set/   # Wallet set configuration
│   │   └── webhooks/     # Webhook handlers (Circle notifications)
│   ├── auth/             # Authentication core functionality
│   │   ├── auth-error/   # Error handling for auth failures
│   │   └── callback/     # OAuth and auth callback handling
│   ├── (auth-pages)/     # Authentication-related pages
│   │   ├── forgot-password/  # Password reset request
│   │   ├── sign-in/      # Login page
│   │   └── sign-up/      # Registration page
│   └── dashboard/        # Protected dashboard routes
│       ├── reset-password/  # Password reset form
│       └── transaction/   # Transaction details view
│
├── components/            # Reusable React components
│   ├── ui/               # Core UI components
│   │   ├── alert-dialog/ # Alert and confirmation dialogs
│   │   ├── button/      # Button components
│   │   ├── card/        # Card layout components
│   │   ├── dialog/      # Modal dialog components
│   │   └── form/        # Form input components
│   ├── agreement/       # Agreement-related components
│   │   ├── delete/      # Agreement deletion dialogs
│   │   ├── details/     # Agreement details views
│   │   └── table/       # Agreement listing components
│   └── wallet/          # Wallet-related components
│       ├── balance/     # Balance display components
│       └── transactions/# Transaction history components
│
├── contracts/              # Smart contract definitions and ABIs
│   ├── escrow_smart_contract/  # Escrow contract implementation
│   └── example_agreement/      # Example agreement with good and bad submission examples
│
├── lib/                    # Library code and utilities
│   ├── supabase/           # Supabase client configuration
│   └── utils/              # Utility functions and helpers
│
├── supabase/               # Supabase-specific configuration
│   └── migrations/         # Database migration files
│
└── types/                  # TypeScript type definitions
```

### Key Directories

- **`app/`**: Core application code using Next.js 13+ app directory structure
  - `actions/`: Server-side actions for authentication and data mutations
  - `api/`: Backend API endpoints organized by functionality:
    - `contracts/`: Smart contract interactions and document analysis
    - `usdc/`: USDC token purchase and sale operations
    - `wallet/`: Digital wallet management and transactions
    - `webhooks/`: External service webhook handlers
  - `auth/`: Authentication system implementation
  - `(auth-pages)/`: Authentication-related pages (login, signup, password reset)
  - `dashboard/`: Protected application routes and features

- **`components/`**: Reusable React components organized by function
  - `ui/`: Core UI component library

- **`contracts/`**: Smart contract related files
  - `escrow_smart_contract/`: Contains the `EscrowWithAgent.sol` contract, which implements the escrow system with agent functionality
  - `example_agreement/`: Contains an example agreement and examples of good and bad submissions

- **`lib/`**: Utility functions and external service configurations
  - `supabase/`: Database client configuration for browser and server
  - `utils/`: Helper functions for amounts, dates, and API clients

- **`supabase/`**: Database configuration and management
  - `migrations/`: SQL migration files for schema changes
  - Configuration files for Supabase setup

- **`types/`**: TypeScript type definitions
  - Database schema types
  - Agreement and escrow-related type definitions
  - Component prop types

This structure follows a modular architecture that separates concerns between the frontend, backend APIs, smart contracts, and database layers while maintaining a clear organization for scaling the application.
